name: Test and deploy to GitHub Pages

on: [push]

jobs:
  init:
    uses: ./.github/workflows/init.yml

  test:
    uses: ./.github/workflows/npm-test.yml
    needs: [init]

  cypress:
    uses: ./.github/workflows/cypress.yml
    needs: [init]

  publish:
    name: Publish
    if: contains( github.ref, 'main')
    runs-on: ubuntu-latest
    needs: [test, cypress]
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: 📰 Publish to NPM (dry run)
        run: npm run publish:abcd

  deploy:
    name: Deploy
    if: contains( github.ref, 'main')
    runs-on: ubuntu-latest
    needs: [test, cypress]
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: 🍼 Create pages build
        run: npm run deploy:pages

      - name: 🥅 Deploy to GH-Pages
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
